<?xml version="1.0"?>
<ZopeData>
  <record id="1" aka="AAAAAAAAAAE=">
    <pickle>
      <global name="PythonScript" module="Products.PythonScripts.PythonScript"/>
    </pickle>
    <pickle>
      <dictionary>
        <item>
            <key> <string>Script_magic</string> </key>
            <value> <int>3</int> </value>
        </item>
        <item>
            <key> <string>_bind_names</string> </key>
            <value>
              <object>
                <klass>
                  <global name="NameAssignments" module="Shared.DC.Scripts.Bindings"/>
                </klass>
                <tuple/>
                <state>
                  <dictionary>
                    <item>
                        <key> <string>_asgns</string> </key>
                        <value>
                          <dictionary>
                            <item>
                                <key> <string>name_container</string> </key>
                                <value> <string>container</string> </value>
                            </item>
                            <item>
                                <key> <string>name_context</string> </key>
                                <value> <string>context</string> </value>
                            </item>
                            <item>
                                <key> <string>name_m_self</string> </key>
                                <value> <string>script</string> </value>
                            </item>
                            <item>
                                <key> <string>name_subpath</string> </key>
                                <value> <string>traverse_subpath</string> </value>
                            </item>
                          </dictionary>
                        </value>
                    </item>
                  </dictionary>
                </state>
              </object>
            </value>
        </item>
        <item>
            <key> <string>_body</string> </key>
            <value> <string encoding="cdata"><![CDATA[

from DateTime import DateTime\n
\n
computer = context\n
portal = context.getPortalObject()\n
allocation_scope = computer.getAllocationScope()\n
\n
if allocation_scope != \'open/public\' and \\\n
   allocation_scope != \'open/friend\':\n
  return\n
\n
is_service_provider = False\n
person = computer.getSourceAdministrationValue(portal_type="Person")\n
\n
for assignment in person.contentValues(portal_type="Assignment"):\n
  assignment = assignment.getObject()\n
  if assignment.getRole() == \'service_provider\':\n
    is_service_provider = True\n
    break\n
\n
if not is_service_provider:\n
  #Turn this computer allocation scope to \'open/personal\'\n
  edit_kw = {\n
    \'allocation_scope\': \'open/personal\',\n
    \'subject_list\': [\'\'],\n
    \'destination_section_value\': person,\n
  } \n
  computer.edit(**edit_kw)\n
\n
  # Create a ticket (or re-open it) for this issue!\n
  ticket_title = \'Allocation scope has been changed for %s\' % computer.\\\n
    getReference()\n
  message = """Dear user,\n
\n
Your computer %s with ID %s was configured with allocation scope \'%s\', but you are\n
not allowed to turn computer to \'public\' or \'friend\' state because you are not a service provider.\n
The computer allocation scope has been changed to \'open/personal\'. Please contact us for more informations.\n
\n
Regards,\n
\n
SlapOS Team\n
""" % (computer.getTitle(), computer.getReference(),\n
       allocation_scope)\n
  ressource = portal.service_module.slapos_crm_information.getRelativeUrl()\n
  \n
  support_request_in_progress = portal.portal_catalog.getResultValue(\n
    portal_type = \'Support Request\',\n
    title = ticket_title,\n
    simulation_state = ["validated","submitted","suspended"],\n
    source_project_uid = computer.getUid()\n
  )\n
  if support_request_in_progress is None:\n
    support_request = portal.support_request_module.\\\n
    slapos_crm_support_request_template.\\\n
    Base_createCloneDocument(batch_mode=1)\n
    support_request.edit(\n
      title = ticket_title,\n
      resource = ressource,\n
      description = ticket_title,\n
      start_date = DateTime(),\n
      destination_decision=computer.getSourceAdministration(),\n
      source_project_value = computer.getRelativeUrl()\n
    )\n
    support_request.validate()\n
    support_request.suspend()\n
  else:\n
    support_request = support_request_in_progress.getObject()\n
  \n
  # create Web message if needed for this ticket\n
  event_list = context.portal_catalog(follow_up_uid=support_request.getUid(), \n
               sort_on=[(\'delivery.start_date\', \'DESC\')],\n
  )\n
  if len(event_list) > 0 and \\\n
      (event_list[0].getStartDate() - DateTime()  < 1):\n
    # User has already been notified this day.\n
    return\n
  event = portal.event_module.slapos_crm_web_message_template.\\\n
    Base_createCloneDocument(batch_mode=1)\n
  event.edit(\n
    title=\'We have changed allocation scope for %s\' % computer.getReference(),\n
    text_content=message,\n
    start_date = DateTime(),\n
    resource = ressource,\n
    source=person.getRelativeUrl(),\n
    follow_up=support_request.getRelativeUrl(),\n
  )\n
  event.stop()\n
  event.deliver()\n


]]></string> </value>
        </item>
        <item>
            <key> <string>_params</string> </key>
            <value> <string></string> </value>
        </item>
        <item>
            <key> <string>id</string> </key>
            <value> <string>Computer_checkAndUpdateAllocationScope</string> </value>
        </item>
      </dictionary>
    </pickle>
  </record>
</ZopeData>
